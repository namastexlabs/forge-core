name: Publish to crates.io

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.8.7 or 0.8.7-rc.30)'
        required: true
        type: string

  # Allow chaining from pre-release.yml
  workflow_call:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string

  push:
    tags:
      # Stable versions: v0.8.7, v0.9.0
      - 'v[0-9]+.[0-9]+.[0-9]+'
      # RC versions: v0.8.7-rc.30
      - 'v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+'

jobs:
  extract-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      is_prerelease: ${{ steps.extract.outputs.is_prerelease }}
    steps:
      - name: Extract version
        id: extract
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            # Extract from tag (remove 'v' prefix)
            VERSION="${GITHUB_REF_NAME#v}"
          fi

          # Detect if this is a pre-release version
          if [[ "$VERSION" == *"-rc"* ]] || [[ "$VERSION" == *"-alpha"* ]] || [[ "$VERSION" == *"-beta"* ]]; then
            echo "üì¶ Publishing PRE-RELEASE version: $VERSION"
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "üì¶ Publishing STABLE version: $VERSION"
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

  publish:
    needs: extract-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Update version in Cargo.toml files
        run: |
          VERSION="${{ needs.extract-version.outputs.version }}"
          echo "Setting version to $VERSION in workspace Cargo.toml"

          # Update workspace version
          sed -i "s/^version = .*/version = \"$VERSION\"/" Cargo.toml

          # Verify the change
          grep "^version = " Cargo.toml

      - name: Verify build
        run: cargo check --workspace

      - name: Check if crates already published
        id: check-published
        run: |
          VERSION="${{ needs.extract-version.outputs.version }}"
          CRATES="forge-core-utils forge-core-executors forge-core-db forge-core-services forge-core-deployment forge-core-local-deployment forge-core-server"

          for crate in $CRATES; do
            RESULT=$(cargo search "$crate" 2>/dev/null | grep "^$crate = " || echo "")
            if [ -n "$RESULT" ]; then
              PUBLISHED=$(echo "$RESULT" | sed 's/.*= "\([^"]*\)".*/\1/')
              if [ "$PUBLISHED" == "$VERSION" ]; then
                echo "SKIP: $crate@$VERSION already published"
              else
                echo "INFO: $crate currently at $PUBLISHED, will publish $VERSION"
              fi
            else
              echo "NEW: $crate not yet on crates.io"
            fi
          done

      - name: Publish crates with rollback safety
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          VERSION="${{ needs.extract-version.outputs.version }}"
          PUBLISHED_CRATES=""
          PUBLISH_ORDER="forge-core-utils forge-core-executors forge-core-db forge-core-services forge-core-deployment forge-core-local-deployment forge-core-server"

          # Rollback function: yank all successfully published crates
          rollback() {
            echo "::error::Publishing failed, initiating rollback..."
            for crate in $PUBLISHED_CRATES; do
              echo "üîÑ Yanking $crate@$VERSION..."
              cargo yank --version "$VERSION" "$crate" 2>/dev/null || echo "‚ö†Ô∏è Could not yank $crate (may not exist yet)"
            done
            echo "::error::Rollback complete. All published crates have been yanked."
            exit 1
          }

          # Trap errors and run rollback
          trap 'rollback' ERR

          for crate in $PUBLISH_ORDER; do
            echo "=== Publishing $crate ==="

            # Check if already published
            RESULT=$(cargo search "$crate" 2>/dev/null | grep "^$crate = " || echo "")
            if [ -n "$RESULT" ]; then
              CURRENT=$(echo "$RESULT" | sed 's/.*= "\([^"]*\)".*/\1/')
              if [ "$CURRENT" == "$VERSION" ]; then
                echo "‚úÖ Skipping $crate - already published at $VERSION"
                continue
              fi
            fi

            # Publish the crate
            if cargo publish -p "$crate" --allow-dirty; then
              PUBLISHED_CRATES="$PUBLISHED_CRATES $crate"
              echo "‚úÖ Published $crate@$VERSION"
              echo "‚è≥ Waiting 45s for crates.io index update..."
              sleep 45
            else
              echo "::error::Failed to publish $crate"
              rollback
            fi
          done

          # Disable trap after successful completion
          trap - ERR
          echo "=== ‚úÖ All crates published successfully! ==="

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ needs.extract-version.outputs.version }}
          prerelease: ${{ needs.extract-version.outputs.is_prerelease }}
          body: |
            ## Published to crates.io

            All forge-core crates are now available on crates.io:

            ```toml
            forge-core-utils = "${{ needs.extract-version.outputs.version }}"
            forge-core-executors = "${{ needs.extract-version.outputs.version }}"
            forge-core-db = "${{ needs.extract-version.outputs.version }}"
            forge-core-services = "${{ needs.extract-version.outputs.version }}"
            forge-core-deployment = "${{ needs.extract-version.outputs.version }}"
            forge-core-local-deployment = "${{ needs.extract-version.outputs.version }}"
            forge-core-server = "${{ needs.extract-version.outputs.version }}"
            ```

            **Type:** ${{ needs.extract-version.outputs.is_prerelease == 'true' && 'üöß Pre-release (RC)' || '‚úÖ Stable' }}
          generate_release_notes: true
