name: Release & Publish to crates.io

on:
  repository_dispatch:
    types: [trigger-pre-release]
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version bump type"
        required: true
        default: "prerelease"
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.version.outputs.new_tag }}
      new_version: ${{ steps.version.outputs.new_version }}
    steps:
      - name: Cache cargo-edit
        uses: actions/cache@v3
        id: cache-cargo-edit
        with:
          path: ~/.cargo/bin/cargo-set-version
          key: cargo-edit-${{ runner.os }}

      - name: Install cargo-edit
        if: steps.cache-cargo-edit.outputs.cache-hit != 'true'
        run: cargo install cargo-edit

      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine and update versions
        id: version
        run: |
          # Get current version from Cargo.toml
          current_version=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $current_version"

          # Check if triggered by forge automation
          if [[ -n "${{ github.event.client_payload.forge_version }}" ]]; then
            echo "üîó Triggered by forge automation"
            new_version="${{ github.event.client_payload.forge_version }}"
          else
            echo "üñêÔ∏è Manual trigger"

            # Parse current version
            base_version=$(echo "$current_version" | sed 's/-rc\.[0-9]*//')

            case "${{ github.event.inputs.version_type }}" in
              prerelease)
                # Extract RC number if exists, otherwise start at 1
                if [[ "$current_version" == *"-rc."* ]]; then
                  rc_num=$(echo "$current_version" | sed 's/.*-rc\.\([0-9]*\)/\1/')
                  new_rc=$((rc_num + 1))
                  new_version="${base_version}-rc.${new_rc}"
                else
                  new_version="${base_version}-rc.1"
                fi
                ;;
              patch)
                # Bump patch version
                IFS='.' read -r major minor patch <<< "$base_version"
                new_version="${major}.${minor}.$((patch + 1))"
                ;;
              minor)
                IFS='.' read -r major minor patch <<< "$base_version"
                new_version="${major}.$((minor + 1)).0"
                ;;
              major)
                IFS='.' read -r major minor patch <<< "$base_version"
                new_version="$((major + 1)).0.0"
                ;;
            esac
          fi

          new_tag="v${new_version}"
          echo "New version: $new_version"
          echo "New tag: $new_tag"
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT

          # Update Cargo workspace version
          cargo set-version --workspace "$new_version"

      - name: Commit and tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add $(find . -name Cargo.toml) Cargo.lock

          if ! git diff --staged --quiet; then
            git commit -m "chore: release v${{ steps.version.outputs.new_version }}"
            git push
          fi

          # Create tag if doesn't exist
          if ! git ls-remote --tags origin | grep -q "refs/tags/${{ steps.version.outputs.new_tag }}$"; then
            git tag -a ${{ steps.version.outputs.new_tag }} -m "Release ${{ steps.version.outputs.new_tag }}"
            git push --tags
          fi

  publish:
    needs: bump-version
    uses: ./.github/workflows/publish-crates.yml
    with:
      version: ${{ needs.bump-version.outputs.new_version }}
    secrets: inherit
